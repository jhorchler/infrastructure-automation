version: '3'

tasks:
  generate-autoinst:
    desc: Generates the final autoyast xml profile
    cmds:
      - pwsh -NoProfile -Command "& {(Get-Content '{{.AUTOYAST_DIRECTORY}}/{{.AUTOYAST_TEMPLATE}}' -Raw).Replace('@@USER_PASSWORD@@','{{.SSH_PASSWORD}}') | Out-File -Encoding utf8NoBOM -Path '{{.AUTOYAST_DIRECTORY}}/{{.AUTOYAST_42}}'}"
      - pwsh -NoProfile -Command "& {(Get-Content '{{.AUTOYAST_DIRECTORY}}/{{.AUTOYAST_TEMPLATE}}' -Raw).Replace('@@USER_PASSWORD@@','{{.SSH_PASSWORD}}') | Out-File -Encoding utf8NoBOM -Path '{{.AUTOYAST_DIRECTORY}}/{{.AUTOYAST_15}}'}"
    vars:
      SSH_PASSWORD:
        sh: pwsh -NoProfile -Command "& {Write-Host (Get-Content {{.HCL_VARIABLES}} | ConvertFrom-StringData).root_password -NoNewline}"

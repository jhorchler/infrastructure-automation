version: '3'

tasks:
    generate-autounattended-xml:
        desc: Generates the final Autounattended.xml file
        cmds:
            - pwsh -NoProfile -Command "& {(Get-Content '{{.UNATTEND_DIRECTORY}}/{{.TEMPLATE_FILE}}' -Raw -Encoding utf8) -replace '@@ADMIN_PASSWORD@@','{{.WINRM_PASSWORD}}' -replace '@@IMAGE_NAME@@','{{.IMAGE_NAME}}' -replace '@@DRIVER_PATH@@','{{.DRIVER_PATH}}' | Out-File -Encoding utf8NoBOM -FilePath '{{.ANSWER_FILE}}'}"
        vars:
            DRIVER_PATH:
                sh: pwsh -NoProfile -Command "& {Write-Host (Get-Content {{.OSVERSION}}.pkrvars.hcl -Raw -Encoding utf8|ConvertFrom-StringData).driver_path -NoNewLine}"
            IMAGE_NAME:
                sh: pwsh -NoProfile -Command "& {Write-Host (Get-Content {{.OSVERSION}}.pkrvars.hcl -Raw -Encoding utf8|ConvertFrom-StringData).image_name -NoNewLine}"
            ANSWER_FILE:
                sh: pwsh -NoProfile -Command "& {Write-Host (Get-Content {{.OSVERSION}}.pkrvars.hcl -Raw -Encoding utf8|ConvertFrom-StringData).answer_file -NoNewLine}"
            WINRM_PASSWORD:
                sh: pwsh -NoProfile -Command "& {Write-Host (Get-Content {{.DEFAULTS_FILE}} -Raw -Encoding utf8|ConvertFrom-StringData).winrm_password -NoNewLine}"
